{% extends 'chat/telegram_base.html' %}
{% load chat_tags %}

{% block title %}{{ room.name }} - Live Chat{% endblock %}

{% block content %}
<style>
    .message-bubble {
        max-width: 70%;
        padding: 12px 16px;
        position: relative;
        word-wrap: break-word;
        display: block;
    }
    
    .message-own {
        background: #2563eb;
        border-radius: 18px 18px 6px 18px;
        margin-left: auto;
        margin-right: 0;
    }
    
    .message-other {
        background: #2f2f2f;
        border-radius: 18px 18px 18px 6px;
        margin-left: 0;
        margin-right: auto;
    }
    
    .delete-btn {
        position: absolute;
        top: -12px;
        right: -12px;
        opacity: 0;
        transition: opacity 0.2s ease;
        display: flex;
        gap: 4px;
    }
    
    .message-bubble:hover .delete-btn {
        opacity: 1;
    }
</style>

<div class="sidebar">
    <div class="sidebar-header">
        <div class="user-info">
            <div class="user-avatar">{{ user.username.0|upper }}</div>
            <div class="user-details">
                <h3>{{ user.username }}</h3>
                <p>Onlayn</p>
            </div>
            <div style="margin-left: auto;">
                <a href="{% url 'chat:logout' %}" 
                   style="color: #8b8b8b; text-decoration: none; padding: 8px; border-radius: 50%; display: inline-block; transition: background 0.15s ease;"
                   onmouseover="this.style.background='#2f2f2f'"
                   onmouseout="this.style.background='transparent'"
                   title="Chiqish">
                    ğŸšª
                </a>
            </div>
        </div>
        <input type="text" class="search-box" placeholder="Chatlarni qidirish...">
        <div style="margin-top: 16px;">
            <a href="{% url 'chat:create_room' %}" 
               style="display: inline-flex; align-items: center; gap: 8px; background: #2563eb; color: white; padding: 10px 16px; border-radius: 12px; text-decoration: none; font-size: 14px; font-weight: 500; transition: background 0.15s ease;"
               onmouseover="this.style.background='#1d4ed8'"
               onmouseout="this.style.background='#2563eb'">
                <span style="font-size: 16px;">â•</span> Yangi Chat
            </a>
        </div>
    </div>

    <div class="chat-list">
        {% for r in user.room_memberships.all %}
            <a href="{% url 'chat:room' r.room.id %}" class="chat-item{% if r.room.id == room.id %} active{% endif %}" style="text-decoration: none; color: inherit; display: block;">
                <div class="chat-header">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px;">
                            {{ r.room.name.0|upper }}
                        </div>
                        <div>
                            <div class="chat-name">{{ r.room.name }}</div>
                            <div class="chat-preview">
                                {{ r.room.members.count }} a'zo
                            </div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        {% if r.room.created_by == user %}
                            <div style="background: #ffd700; color: #000; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: 600;">
                                Admin
                            </div>
                        {% endif %}
                    </div>
                </div>
            </a>
        {% endfor %}
    </div>
</div>

<div class="main-content">
    <!-- Chat header -->
    <div class="chat-header-main">
        <button class="back-btn" onclick="history.back()">â†</button>
        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px;">
            {{ room.name.0|upper }}
        </div>
        <div class="chat-info">
            <h3>{{ room.name }}</h3>
            <p>{{ room.members.count }} a'zo</p>
        </div>
        <div style="margin-left: auto; display: flex; gap: 8px;">
            {% if room.created_by == user %}
                <form method="post" action="{% url 'chat:delete_room' room.id %}" style="display: inline;" onsubmit="return confirm('Bu xonani butunlay o\'chirishni xohlaysizmi? Bu amalni bekor qilib bo\'lmaydi!')">
                    {% csrf_token %}
                    <button type="submit" 
                            style="color: #ff4757; background: none; border: none; padding: 8px; border-radius: 50%; display: inline-block; transition: background 0.15s ease; cursor: pointer;"
                            onmouseover="this.style.background='#2f2f2f'"
                            onmouseout="this.style.background='transparent'"
                            title="Xonani o'chirish">
                        ğŸ—‘ï¸
                    </button>
                </form>
            {% endif %}
            <a href="{% url 'chat:index' %}" 
               style="color: #8b8b8b; text-decoration: none; padding: 8px; border-radius: 50%; display: inline-block; transition: background 0.15s ease;"
               onmouseover="this.style.background='#2f2f2f'"
               onmouseout="this.style.background='transparent'"
               title="Bosh sahifa">
                ğŸ 
            </a>
        </div>
    </div>

    <!-- Messages container -->
    <div class="messages-container" id="messagesContainer">
        <div style="padding: 20px;">
            {% for message in messages %}
                {% if message.content or message.file %}
                    <div style="margin-bottom: 16px; display: block; width: 100%;">
                        <div data-message="{{ message.id }}" class="message-bubble {% if message.user == user %}message-own{% else %}message-other{% endif %}">
                        
                        <!-- Delete buttons (only for message owner or room admin) -->
                        {% if message.user == user or room.created_by == user %}
                            <div class="delete-btn" style="position: absolute; top: -12px; right: -12px; opacity: 0; transition: opacity 0.2s ease; display: flex; gap: 4px;">
                                <!-- Delete all message -->
                                <form method="post" action="{% url 'chat:delete_content' message.id 'all' %}" style="display: inline;" onsubmit="return confirm('Butun xabarni o\'chirishni xohlaysizmi?')">
                                    {% csrf_token %}
                                    <button type="submit" style="background: #ff4757; border: none; color: white; width: 24px; height: 24px; border-radius: 50%; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s ease;" onmouseover="this.style.background='#ff3742'" onmouseout="this.style.background='#ff4757'" title="Butun xabarni o'chirish">
                                        ğŸ—‘ï¸
                                    </button>
                                </form>
                                
                                {% if message.content and message.file %}
                                    <!-- Delete only text -->
                                    <form method="post" action="{% url 'chat:delete_content' message.id 'text' %}" style="display: inline;" onsubmit="return confirm('Faqat matnni o\'chirishni xohlaysizmi?')">
                                        {% csrf_token %}
                                        <button type="submit" style="background: #ffa726; border: none; color: white; width: 24px; height: 24px; border-radius: 50%; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s ease;" onmouseover="this.style.background='#ff9800'" onmouseout="this.style.background='#ffa726'" title="Faqat matnni o'chirish">
                                            ğŸ“
                                        </button>
                                    </form>
                                    
                                    <!-- Delete only file -->
                                    <form method="post" action="{% url 'chat:delete_content' message.id 'file' %}" style="display: inline;" onsubmit="return confirm('Faqat faylni o\'chirishni xohlaysizmi?')">
                                        {% csrf_token %}
                                        <button type="submit" style="background: #42a5f5; border: none; color: white; width: 24px; height: 24px; border-radius: 50%; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s ease;" onmouseover="this.style.background='#2196f3'" onmouseout="this.style.background='#42a5f5'" title="Faqat faylni o'chirish">
                                            ğŸ“
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                        {% endif %}
                        
                        {% if message.user != user %}
                            <div style="color: #67a3ff; font-size: 13px; font-weight: 500; margin-bottom: 4px;">
                                {{ message.user.username }}
                            </div>
                        {% endif %}
                        
                        {% if message.content %}
                            <div style="color: #ffffff; font-size: 15px; line-height: 1.4; word-wrap: break-word;">
                                {{ message.content }}
                            </div>
                        {% endif %}
                        
                        {% if message.file %}
                            <div style="margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="font-size: 20px;">ğŸ“</div>
                                    <div style="flex: 1;">
                                        <div style="color: #ffffff; font-size: 14px; font-weight: 500;">
                                            {{ message.file.name|slice:"10:" }}
                                        </div>
                                        <div style="color: #8b8b8b; font-size: 12px;">
                                            {{ message.get_file_size_display }}
                                        </div>
                                    </div>
                                    <a href="{% url 'chat:download_file' message.id %}" 
                                       style="background: rgba(76, 175, 80, 0.8); color: white; padding: 8px 16px; border-radius: 8px; text-decoration: none; font-size: 13px; font-weight: 500; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 4px;"
                                       onmouseover="this.style.background='rgba(76, 175, 80, 1)'; this.style.transform='translateY(-1px)'"
                                       onmouseout="this.style.background='rgba(76, 175, 80, 0.8)'; this.style.transform='translateY(0)'"
                                       title="Xavfsiz yuklab olish">
                                        ğŸ“¥ Yuklab olish
                                    </a>
                                </div>
                            </div>
                        {% endif %}
                        
                        <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 4px; text-align: right;">
                            {{ message.timestamp|date:"H:i" }}
                        </div>
                        </div>
                    </div>
                {% endif %}
            {% empty %}
                <div style="text-align: center; color: #8b8b8b; padding: 40px; margin-top: 40px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">ï¿½</div>
                    <h3 style="color: #ffffff; margin-bottom: 8px;">Hali xabar yo'q</h3>
                    <p>Birinchi xabarni yozing!</p>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Input area -->
    <div class="input-area">
        <form method="post" enctype="multipart/form-data" class="input-form">
            {% csrf_token %}
            <button type="button" class="attach-btn" onclick="document.getElementById('fileInput').click()" title="Fayl biriktirish">
                ğŸ“
            </button>
            <input type="file" name="file" id="fileInput" 
                   accept=".txt,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.gif,.webp,.svg,.mp3,.wav,.mp4,.avi,.mkv,.webm,.zip,.rar,.7z,.tar,.gz" 
                   style="display: none;" 
                   onchange="updateFileName(this)"
                   title="Ruxsat etilgan fayllar: rasmlar, hujjatlar, audio/video, arxiv fayllar">
            <textarea name="content" 
                      class="message-input" 
                      placeholder="Xabar yozing..." 
                      rows="1"
                      onkeypress="handleKeyPress(event)"
                      oninput="autoResize(this)"></textarea>
            <button type="submit" class="send-btn" title="Yuborish">
                âœˆï¸
            </button>
        </form>
    </div>

</div>

<script>
    // Auto-scroll to bottom
    function scrollToBottom() {
        const container = document.getElementById('messagesContainer');
        container.scrollTop = container.scrollHeight;
    }

    // Handle enter key
    function handleKeyPress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            event.target.form.submit();
        }
    }

    // Auto-resize textarea
    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    // Update file name with validation
    function updateFileName(input) {
        const btn = document.querySelector('.attach-btn');
        
        if (input.files.length > 0) {
            const file = input.files[0];
            
            // Fayl hajmini tekshirish (50MB)
            const maxSize = 50 * 1024 * 1024; // 50MB
            if (file.size > maxSize) {
                alert('Fayl hajmi 50MB dan katta bo\'lishi mumkin emas!');
                input.value = '';
                btn.innerHTML = 'ğŸ“';
                btn.style.color = '#8b8b8b';
                return;
            }
            
            // Fayl kengaytmasini tekshirish
            const allowedExtensions = [
                '.txt', '.pdf', '.doc', '.docx', '.xls', '.xlsx', '.ppt', '.pptx',
                '.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg',
                '.mp3', '.wav', '.mp4', '.avi', '.mkv', '.webm',
                '.zip', '.rar', '.7z', '.tar', '.gz'
            ];
            
            const fileExt = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedExtensions.includes(fileExt)) {
                alert('Fayl turi ruxsat etilmagan: ' + fileExt + '\n\nRuxsat etilgan turlar:\nâ€¢ Hujjatlar: PDF, Word, Excel, PowerPoint\nâ€¢ Rasmlar: JPG, PNG, GIF, WebP, SVG\nâ€¢ Audio/Video: MP3, WAV, MP4, AVI, MKV, WebM\nâ€¢ Arxivlar: ZIP, RAR, 7Z, TAR, GZ\nâ€¢ Matnlar: TXT');
                input.value = '';
                btn.innerHTML = 'ğŸ“';
                btn.style.color = '#8b8b8b';
                return;
            }
            
            // Muvaffaqiyatli yuklandi
            const fileName = file.name.length > 15 ? file.name.substring(0, 15) + '...' : file.name;
            btn.innerHTML = 'âœ… ' + fileName;
            btn.style.color = '#4caf50';
            btn.title = 'Tanlangan fayl: ' + file.name + ' (' + formatFileSize(file.size) + ')';
        } else {
            btn.innerHTML = 'ğŸ“';
            btn.style.color = '#8b8b8b';
            btn.title = 'Fayl biriktirish';
        }
    }
    
    // Fayl hajmini formatlar
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        scrollToBottom();
        
        // Add hover effect for delete buttons
        const messageContainers = document.querySelectorAll('[data-message]');
        messageContainers.forEach(container => {
            const deleteBtn = container.querySelector('.delete-btn');
            if (deleteBtn) {
                container.addEventListener('mouseenter', () => {
                    deleteBtn.style.opacity = '1';
                });
                container.addEventListener('mouseleave', () => {
                    deleteBtn.style.opacity = '0';
                });
            }
        });
    });
</script>
{% endblock %}